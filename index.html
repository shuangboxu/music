<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>éŸ³ä¹æœç´¢</title>
  <style>
    body { font-family: Arial; background: #f0f0f0; padding: 20px; }
    h1 { text-align: center; }
    #searchBox { text-align: center; margin-bottom: 20px; }
    input[type="text"], select { padding: 10px; font-size: 16px; }
    button { padding: 10px 15px; font-size: 16px; margin-left: 5px; cursor: pointer; }
    .song-card {
      background: white; padding: 15px; margin: 10px auto; border-radius: 8px;
      max-width: 600px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .song-title { font-weight: bold; }
    .song-actions { margin-top: 10px; }
    audio { width: 100%; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ğŸµ éŸ³ä¹æœç´¢ ğŸµ</h1>
  <p style="color: #555; text-align: center;">QQéŸ³ä¹å¹³å°æœç´¢</p>
  <div id="searchBox">
    <input type="text" id="songInput" placeholder="è¯·è¾“å…¥æ­Œæ›²åç§°/æ­Œæ‰‹å" size="16">
    æ˜¾ç¤ºæ•°é‡ï¼š
    <select id="numSelect">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="30">30</option>
    </select>
    <button onclick="searchList()">æœç´¢æ­Œæ›²</button>
    <button onclick="searchAndLoadAll()">åŠ è½½æ­Œæ›²è¯¦ç»†ä¿¡æ¯</button>
  </div>
  <div id="results"></div>

  <script>
    let currentQuery = "";
    let currentNum = 10;

    async function searchList() {
      const songName = document.getElementById("songInput").value.trim();
      const num = document.getElementById("numSelect").value;
      if (!songName) {
        alert("è¯·è¾“å…¥æ­Œæ›²åï¼");
        return false;
      }
      currentQuery = songName;
      currentNum = parseInt(num);

      const url = `http://lpz.chatc.vip/apiqq.php?msg=${encodeURIComponent(songName)}&type=json&num=${num}`;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "åŠ è½½ä¸­...";

      try {
        const res = await fetch(url);
        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (err) {
          resultsDiv.innerHTML = `<pre>${text}</pre>`;
          return false;
        }

        const songList = Array.isArray(json) ? json : (json.data || []);
        if (!songList.length) {
          resultsDiv.innerHTML = "æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²";
          return false;
        }

        resultsDiv.innerHTML = "";
        for (let i = 0; i < songList.length; i++) {
          const item = songList[i];
          const singer = item.song_singer || "æœªçŸ¥æ­Œæ‰‹";
          const card = document.createElement("div");
          card.className = "song-card";
          card.innerHTML = `
            <div class="song-title">${i + 1}. æ­Œæ‰‹ï¼š${singer}</div>
            <div class="song-actions">
              <button onclick="loadAndPlay(${i + 1})">ğŸ§ åŠ è½½æ’­æ”¾</button>
              <div id="player-${i + 1}"></div>
            </div>
          `;
          resultsDiv.appendChild(card);
        }
        return true;
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = "æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
        return false;
      }
    }

    async function loadAndPlay(index) {
      const url = `http://lpz.chatc.vip/apiqq.php?msg=${encodeURIComponent(currentQuery)}&n=${index}&type=json&br=1`;
      const playerDiv = document.getElementById(`player-${index}`);
      playerDiv.innerHTML = "æ­£åœ¨åŠ è½½...";

      try {
        const res = await fetch(url);
        const song = await res.json();

        if (song.code !== 200 || !song.data || !song.data.music_url) {
          playerDiv.innerHTML = "è·å–æ’­æ”¾é“¾æ¥å¤±è´¥";
          return;
        }

        const m = song.data;
        let platform = "æœªçŸ¥å¹³å°";
        if (m.link.includes("qq")) platform = "QQéŸ³ä¹";
        else if (m.link.includes("kugou")) platform = "é…·ç‹—éŸ³ä¹";
        else if (m.link.includes("netease")) platform = "ç½‘æ˜“äº‘éŸ³ä¹";

        playerDiv.innerHTML = `
          <img src="${m.cover}" alt="å°é¢" style="width:80px;float:left;margin-right:10px;">
          <div style="overflow:hidden;">
            <div><strong>${m.song_name}</strong> - ${m.song_singer}ï¼ˆ${platform}ï¼‰</div>
            <div>éŸ³è´¨ï¼š${m.quality || "æœªçŸ¥"}</div>
            <audio controls src="${m.music_url}"></audio>
            <br><a href="${m.music_url}" download target="_blank">â¬‡ï¸ ä¸‹è½½</a>
            <details style="margin-top:8px;"><summary>æ­Œè¯</summary><pre>${m.lyric || "æš‚æ— æ­Œè¯"}</pre></details>
          </div>
        `;
      } catch (err) {
        console.error(err);
        playerDiv.innerHTML = "åŠ è½½å¤±è´¥";
      }
    }

    function loadAllSongs() {
      for (let i = 1; i <= currentNum; i++) {
        loadAndPlay(i);
      }
    }

    async function searchAndLoadAll() {
      const success = await searchList();
      if (success) {
        loadAllSongs();
      }
    }
  </script>
</body>
</html>
